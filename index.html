const url = "https://script.google.com/macros/s/AKfycby5vwvZKULUs2ULIiGqn0higkzKfagQkHrfhASKCKjCqN28KVljQh0M45_dwZDROPsKCg/exec";

document.addEventListener("DOMContentLoaded", () => {
  cargarTipificaciones();
  document.getElementById("fecha_hora").value = new Date().toLocaleString("es-MX");

  document.getElementById("generar").addEventListener("click", generarRegistroAleatorio);
  document.getElementById("guardar").addEventListener("click", guardarRegistro);
  document.getElementById("buscar").addEventListener("click", buscarRegistro);
});

// Cargar tipificaciones desde hoja TIPIFICACIONES
function cargarTipificaciones() {
  fetch(`${url}?action=tipificaciones`)
    .then(res => res.json())
    .then(data => {
      const select = document.getElementById("tipificacion");
      select.innerHTML = '<option value="">Seleccione</option>';
      data.forEach(tipi => {
        const option = document.createElement("option");
        option.value = tipi;
        option.textContent = tipi;
        select.appendChild(option);
      });
    })
    .catch(error => alert("Error al cargar tipificaciones"));
}

// Generar datos aleatorios desde BDD
function generarRegistroAleatorio() {
  fetch(`${url}?action=generar`)
    .then(res => res.json())
    .then(data => {
      llenarFormulario(data);
    })
    .catch(error => alert("Error al generar registro"));
}

// Buscar por número celular en hoja REGISTROS
function buscarRegistro() {
  const celularBuscar = document.getElementById("buscar_celular").value.trim();
  if (!celularBuscar) {
    alert("Por favor, ingresa un número de celular para buscar.");
    return;
  }

  fetch(`${url}?action=buscar&celular=${encodeURIComponent(celularBuscar)}`)
    .then(res => res.json())
    .then(data => {
      if (data && data.celular) {
        llenarFormulario(data);
      } else {
        alert("No se encontró un registro con ese número de celular.");
      }
    })
    .catch(error => alert("Error al buscar el registro"));
}

// Guardar nuevo registro en hoja REGISTROS
function guardarRegistro() {
  const usuario = document.getElementById("usuario").value.trim();
  if (!usuario) {
    alert("Por favor escribe tu nombre completo en el campo Usuario.");
    return;
  }

  const datos = {
    nombre: document.getElementById("nombre").value,
    celular: document.getElementById("celular").value,
    cliente: document.getElementById("cliente").value,
    tel_fijo: document.getElementById("tel_fijo").value,
    edad: document.getElementById("edad").value,
    antiguedad: document.getElementById("antiguedad").value,
    zona: document.getElementById("zona").value,
    tipificacion: document.getElementById("tipificacion").value,
    correo: document.getElementById("correo").value,
    observaciones: document.getElementById("observaciones").value,
    fecha_hora: document.getElementById("fecha_hora").value,
    usuario: usuario
  };

  fetch(url, {
    method: "POST",
    body: JSON.stringify(datos),
    headers: {
      "Content-Type": "application/json"
    }
  })
    .then(res => res.text())
    .then(response => alert("Registro guardado correctamente"))
    .catch(error => alert("Error al guardar el registro"));
}

// Llenar el formulario con datos
function llenarFormulario(data) {
  document.getElementById("nombre").value = data.nombre || "";
  document.getElementById("celular").value = data.celular || "";
  document.getElementById("cliente").value = data.cliente || "";
  document.getElementById("tel_fijo").value = data.tel_fijo || "";
  document.getElementById("edad").value = data.edad || "";
  document.getElementById("antiguedad").value = data.antiguedad || "";
  document.getElementById("zona").value = data.zona || "";
  document.getElementById("tipificacion").value = data.tipificacion || "";
  document.getElementById("correo").value = data.correo || "";
  document.getElementById("observaciones").value = data.observaciones || "";
  document.getElementById("fecha_hora").value = new Date().toLocaleString("es-MX");
}
